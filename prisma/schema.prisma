generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum UserStatus {
  INVITED
  ACTIVE
  DISABLED
  DELETED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum ItemType {
  PLACE
  FOOD
}

enum ItemStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VoteValue {
  APPROVE
  REJECT
}

enum TripRole {
  ADMIN  // Creador del viaje — control total
  EDITOR // Puede agregar items/gastos, no puede borrar el viaje
  VIEWER // Solo lectura
}

enum ParticipantType {
  REGISTERED // Usuario registrado
  GHOST      // Nombre fantasma para división de gastos (sin cuenta)
}

enum Currency {
  CLP // Peso Chileno
  JPY // Yen Japonés
  USD // Dólar Americano
  EUR // Euro
  GBP // Libra Esterlina
  KRW // Won Coreano
  CNY // Yuan Chino
  THB // Baht Tailandés
}

enum SplitType {
  EQUAL  // División equitativa entre participantes
  CUSTOM // Montos específicos por participante
}

// ─── NextAuth required models ─────────────────────────────────────────────────

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// ─── Users & Invitations ──────────────────────────────────────────────────────

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  image         String?
  emailVerified DateTime?
  status        UserStatus @default(INVITED)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  accounts        Account[]
  sessions        Session[]
  invitationsSent Invitation[]     @relation("InvitedBy")
  invitationUsed  Invitation?      @relation("AcceptedBy")
  createdItems    Item[]
  votes           Vote[]
  checks          Check[]
  createdTrips    Trip[]           @relation("TripCreatedBy")
  participations  TripParticipant[] @relation("UserParticipant")
  expenses        Expense[]        @relation("ExpenseCreatedBy")
}

model Invitation {
  id        String           @id @default(cuid())
  email     String
  token     String           @unique @default(cuid())
  status    InvitationStatus @default(PENDING)
  expiresAt DateTime
  createdAt DateTime         @default(now())

  invitedById  String
  invitedBy    User   @relation("InvitedBy", fields: [invitedById], references: [id])

  acceptedById String? @unique
  acceptedBy   User?   @relation("AcceptedBy", fields: [acceptedById], references: [id])

  @@index([email])
}

// ─── Trips & Participants ─────────────────────────────────────────────────────

model Trip {
  id              String    @id @default(cuid())
  name            String
  description     String?
  destination     String?
  startDate       DateTime?
  endDate         DateTime?
  defaultCurrency Currency  @default(CLP)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  createdById String
  createdBy   User   @relation("TripCreatedBy", fields: [createdById], references: [id])

  participants TripParticipant[]
  items        Item[]
  activities   Activity[]
  hotels       Hotel[]
  expenses     Expense[]
  payments     Payment[]

  @@index([createdById])
  @@index([startDate, endDate])
}

model TripParticipant {
  id       String          @id @default(cuid())
  tripId   String
  userId   String?         // NULL si es participante fantasma
  name     String          // Nombre del participante (usuario o fantasma)
  type     ParticipantType @default(REGISTERED)
  role     TripRole        @default(VIEWER)
  joinedAt DateTime        @default(now())

  trip Trip  @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User? @relation("UserParticipant", fields: [userId], references: [id], onDelete: SetNull)

  expenseParticipants ExpenseParticipant[]
  paidExpenses        Expense[]            @relation("ExpensePaidBy")
  paymentsMade        Payment[]            @relation("PaymentsFrom")
  paymentsReceived    Payment[]            @relation("PaymentsTo")

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

// ─── Items (proposals + voting) ───────────────────────────────────────────────

model Item {
  id          String     @id @default(cuid())
  title       String
  description String?
  type        ItemType
  location    String?
  externalUrl String?
  imageUrl    String?
  status      ItemStatus @default(PENDING)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  votes      Vote[]
  checks     Check[]
  activities Activity[] // Items aprobados pueden ser referenciados desde el itinerario

  @@index([tripId])
}

model Vote {
  id        String    @id @default(cuid())
  value     VoteValue
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  itemId String
  item   Item   @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
}

model Check {
  id       String  @id @default(cuid())
  photoUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  itemId String
  item   Item   @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
}

// ─── Itinerary (Activities) ───────────────────────────────────────────────────

model Activity {
  id           String    @id @default(cuid())
  tripId       String
  title        String
  description  String?
  location     String?
  activityDate DateTime?
  activityTime String?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Referencia opcional a un Item aprobado que originó esta actividad
  itemId String?
  item   Item?   @relation(fields: [itemId], references: [id], onDelete: SetNull)

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([activityDate])
  @@index([itemId])
}

// ─── Hotels ───────────────────────────────────────────────────────────────────

model Hotel {
  id             String   @id @default(cuid())
  tripId         String
  name           String
  link           String?
  checkInDate    DateTime
  checkOutDate   DateTime
  pricePerNight  Float?
  totalPrice     Float?
  numberOfNights Int
  currency       Currency @default(CLP)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([checkInDate, checkOutDate])
}

// ─── Expenses & Payments (Splitwise-style) ────────────────────────────────────

model Expense {
  id                  String    @id @default(cuid())
  tripId              String
  createdById         String
  paidByParticipantId String?
  description         String
  amount              Float
  currency            Currency  @default(CLP)
  expenseDate         DateTime  @default(now())
  splitType           SplitType @default(EQUAL)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  trip     Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdBy User            @relation("ExpenseCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  paidBy   TripParticipant? @relation("ExpensePaidBy", fields: [paidByParticipantId], references: [id], onDelete: SetNull)

  participants ExpenseParticipant[]

  @@index([tripId])
  @@index([createdById])
  @@index([paidByParticipantId])
  @@index([expenseDate])
}

model ExpenseParticipant {
  id            String @id @default(cuid())
  expenseId     String
  participantId String
  amount        Float

  expense     Expense         @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  participant TripParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([expenseId, participantId])
  @@index([expenseId])
  @@index([participantId])
}

model Payment {
  id                String   @id @default(cuid())
  tripId            String
  fromParticipantId String
  toParticipantId   String
  amount            Float
  currency          Currency
  paidAt            DateTime @default(now())
  createdAt         DateTime @default(now())

  trip            Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  fromParticipant TripParticipant @relation("PaymentsFrom", fields: [fromParticipantId], references: [id], onDelete: Cascade)
  toParticipant   TripParticipant @relation("PaymentsTo", fields: [toParticipantId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([fromParticipantId])
  @@index([toParticipantId])
}
